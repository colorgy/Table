<div class="container-fluid">
  <div class="row">
    <div class="poll-statistics">
      <h5>戰況分析</h5>
      <div class="poll-statistics-bar--fresh">
        小鮮肉(<span class="fresh-percent"></span>%)
      </div>
      <div class="poll-statistics-bar--notfresh">
        老油條(<span class="notfresh-percent"></span>%)
      </div>
    </div>
  </div>
</div>
<div class="container-fluid">
  <div class="row row-inner">
    <div class="poll">
      <div class="poll-inner">
        <div class="vs-field">
          <p>v.s</p>
          <div class="give-up-block">
            <a class="btn btn--small give-up-btn" id="give-up-btn">
              棄票
            </a>
          </div>
          <div style="clear:both;"></div>
        </div>
        <div class="poll-user-item user-one" user-id="">
          <div class="poll-user-avatar user-one">
            
          </div>
          <div>
            <a class="btn poll-user-btn user-one" user-id="" fresh-key="">
              <i class="material-icons">favorite</i>投他
            </a>
          </div>
        </div>
        <div class="poll-user-item user-two" user-id="">
          <div class="poll-user-avatar user-two">
            
          </div>
          <div>
            <a class="btn poll-user-btn user-two" user-id="" fresh-key="">
              <i class="material-icons">favorite</i>投他
            </a>
          </div>
        </div>
        <div style="clear:both;"></div>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  var fresh_user_id;
  var not_fresh_user_id;
  var fresh_key;
  var not_fresh_key;
  var not_fresh_user_started_year;

  function get_user_sample(){
    var get_url = '/get-poll-sample?gender=male';
    $.get(get_url, function(response){
      var fresh_user = response["found_user_fresh"];
      var not_fresh_user = response["found_user_not_fresh"];
      var random_integer = Math.floor((Math.random() * 2) + 1);
      var fresh_user_avatar;
      var not_fresh_user_avatar;
      console.log(response);
      console.log(fresh_user);
      console.log(not_fresh_user);

      fresh_user_id = fresh_user.id;
      not_fresh_user_id = not_fresh_user.id;
      not_fresh_user_started_year = not_fresh_user.started_year;
      fresh_key = Math.floor((Math.random() * 2) + 1);

      if( fresh_key == 1 ){
        not_fresh_key = 2;
      }else{
        not_fresh_key = 1;
      }

      if (fresh_user.avatar_url == '' || fresh_user.avatar_url == 'undefined' || fresh_user.avatar_url == null || fresh_user.avatar_url == 'null'){
        fresh_user_avatar = '<%= image_path('angel2.png') %>';
      }else{
        fresh_user_avatar = fresh_user.avatar_url;
      }

      if (not_fresh_user.avatar_url == '' || not_fresh_user.avatar_url == 'undefined' || not_fresh_user.avatar_url == null || not_fresh_user.avatar_url == 'null'){
        not_fresh_user_avatar = '<%= image_path('angel2.png') %>';
      }else{
        not_fresh_user_avatar = not_fresh_user.avatar_url;
      }
      
      if(random_integer == 1){
        $('.poll-user-avatar.user-one').html('<img src="' + fresh_user_avatar + '">');
        $('.poll-user-avatar.user-two').html('<img src="' + not_fresh_user_avatar + '">');
        $('.poll-user-btn.user-one').attr('user-id', fresh_user.id);
        $('.poll-user-btn.user-two').attr('user-id', not_fresh_user.id);
        $('.poll-user-btn.user-one').attr('fresh-key', fresh_key);
        $('.poll-user-btn.user-two').attr('fresh-key', not_fresh_key);

      }else{
        $('.poll-user-avatar.user-two').html('<img src="' + fresh_user_avatar + '">');
        $('.poll-user-avatar.user-one').html('<img src="' + not_fresh_user_avatar + '">');
        $('.poll-user-btn.user-two').attr('user-id', fresh_user.id);
        $('.poll-user-btn.user-one').attr('user-id', not_fresh_user.id);
        $('.poll-user-btn.user-two').attr('fresh-key', fresh_key);
        $('.poll-user-btn.user-one').attr('fresh-key', not_fresh_key);
      }

      setTimeout(function() {
        $('.poll-user-item.user-one').addClass('active');
        $('.poll-user-item.user-two').addClass('active');
      }, 1000);

    })
  }

  function poll(user_polled_user_id, target_fresh_key){
    var gender = 'male';
    var user_started_year;
    var user_id = '<%= current_user.id %>';

    if(parseInt(target_fresh_key) == fresh_key){
      user_started_year = 2015;

    }else{
      user_started_year = not_fresh_user_started_year;
    }

    $.post('<%= polls_path %>', { "poll[user_id]": user_id, "poll[user_polled_user_id]": user_polled_user_id, "poll[user_polled_user_gender]": gender, "poll[user_polled_user_started_year]": user_started_year } ,function(response){

      $('.poll-user-item.user-one').removeClass('active');
      $('.poll-user-item.user-two').removeClass('active');
      
      flash.success('成功投票');
      get_poll_result();
      setTimeout(function() {
        get_user_sample();        
      }, 500);
    })
  }

  function get_poll_result(){
    var get_url = '/get-poll-result?gender=male';
    $.get(get_url, function(response){
      var poll_total = response["poll_total"];
      var poll_fresh_total = response["poll_fresh_total"];
      var poll_fresh_percentage = (poll_fresh_total * 100 / poll_total).toFixed(2);
      var poll_not_fresh_percentage = (100 - poll_fresh_percentage).toFixed(2);

      $('.fresh-percent').html(poll_fresh_percentage);
      $('.notfresh-percent').html(poll_not_fresh_percentage);

      $('.poll-statistics-bar--fresh').css({ 'width' : poll_fresh_percentage + '%' });
      $('.poll-statistics-bar--notfresh').css({ 'width' : poll_not_fresh_percentage + '%' });


    })
  }

  function replaceErrorImageUrl(){
    var image_url = '<%= image_path('angel1.png') %>';
    $('img').error(function(){
      $(this).attr('src', image_url);
    });
    $('img').each(function(){
      if( $(this).attr('src') == ''){
        $(this).attr('src', image_url);
      }
    });
  }

  $('.poll-user-btn').click(function(){
    var user_polled_user_id = parseInt($(this).attr('user-id'));
    var target_fresh_key = parseInt($(this).attr('fresh-key'));
    poll(user_polled_user_id, target_fresh_key);
  })

  $('#give-up-btn').click(function(){
    $('.poll-user-item.user-one').removeClass('active');
    $('.poll-user-item.user-two').removeClass('active');
    flash.success('你棄票囉！');
      setTimeout(function() {
        get_user_sample();        
      }, 500);

  })

  $(document).ready(function(){
    get_user_sample();
    get_poll_result();
    replaceErrorImageUrl();

  })
</script>
