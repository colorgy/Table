<script>
//Draggable
	$(function(){
		$( ".simulator-table-course" ).draggable({
			revert: true,
			start: function() {
				$(this).removeClass('active');
				$('.garbage-can-field').addClass('active');
				$('.mobile-bottom-nav').addClass('hide');
			},
			drag: function() {
			},
			stop: function() {
				$(this).addClass('active');
				$('.garbage-can-field').removeClass('active');
				$('.mobile-bottom-nav').removeClass('hide');
			}

		});
		$(".garbage-can-field").droppable({
	        activeClass: "",
	        hoverClass: "hover",
	        accept: ".simulator-table-course",
	        drop: function(event, ui) {
			 	item_id = $(ui.draggable).attr('iid');
				$.ajax({
					url:'/courses_simulator/' + item_id,
					type: 'DELETE',
					success: function(response) {
						var item = response["item"];
						var course = response["course"];
						var course_name = course.course_name;

						$('.course-id[cid="' + item.course_id + '"]').parent('.course-select-item').removeClass('disabled');
						console.log(item);
						$('.item-id[iid=' + item["id"] +']').parent('.course-hasselect-item').remove();
						$('.simulator-table-course[iid="' + item["id"] + '"]').remove();
						Materialize.toast('"' + course_name + '" 已經移出課表！', 2000);
						CourseConflictTest();
						CourseCreditsCounter();
					}
				})
	        }
	    })
	});
//
</script>
<div class="container-fuild" style="padding-top: 35px;">
	<div class="row">
		<div class="col-md-3 simulator-fixed" dataPage="mobile" id="select-page">
			<div class="page-slider">
				<ul class="tabs">
					<li class="tab col s3 simulator-sidebar-trigger"><a class="active" href="#test1">課程選擇</a></li>
					<li class="tab col s3 course-hasselect-field-trigger"><a href="#test2">已選課表(<span id="credits-total"></span>)</a></li>
				</ul>
				<div id="test1" class="col s12" style="background-color: #4A4A4A;   height: 100%;">
					<div class="simulator-sidebar">
						<div class="simulator-sidebar-inner">
							<div class="course-search-field">
								<div class="course-search-field-inner">
									<!--
									<form class="school-select-form">
										<select class="browser-default">
											<option value="" disabled selected>Choose your school</option>
											<option value="1">台灣科技大學</option>
											<option value="2">台灣大學</option>
											<option value="3">清華大學</option>
											<option value="3">交通大學</option>
											<option value="3">政治大學</option>
										</select>
									</form>
									-->
									<form class="course-search-form">
										<input id="course-searchbox" class="course-searchbox" type="search" placeholder="Search..">
									</form>
								</div>
							</div>
							<div class="course-select-field">
								<div class="simulator-search-result">
									<% @course.each do |c| %>
										<div class="course-select-item">
											<div class="name"><%= link_to c.course_name, c %></div>
											<div class="lecturer"><%= c.lecturer_name %></div>
											<div class="course-code"><%= c.course_code %></div>
											<br>
											<div class="course-time"><%= c.course_time %></div>
											<div class="course-location"><%= c.location %></div>
											<div class="course-credits"><%= c.credits %></div>
											<button class="add-to-simulator">+</button>
											<div class="course-id" cid="<%= c.id %>"></div>
										</div>
									<% end %>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div id="test2" class="col s12" style="background-color: #F89680;   height: 100%;">
					<div class="course-hasselect-field" id="course-hasselect-field">
						<!--<div class="course-hasselect-field-trigger" id="course-hasselect-field-trigger">
							<p>已</p>
							<p>選</p>
							<p>課</p>
							<p>表</p>
							<p></p>
						</div>-->
						<div class="course-hasselect-field-inner">
							<% @courses_simulator_items.each do |item| %>
								<div class="course-hasselect-item">
								  <div class="name">
								  	<%= link_to item.course.course_name, item.course %>
								  </div>
								  <div class="lecturer"><%= item.course.lecturer_name %></div>
								  <div class="code"><%= item.course.course_code %></div>
								  <br>
								  <div class="time"><%= item.course.course_time %></div>
								  <div class="location"><%= item.course.location %></div>
								  <div class="credits"><%= item.course.credits %></div>
								  <button class="remove-hasselect-course"><i class="mdi-content-clear" style="color:black;"></i></button>
								  <div class="item-id" iid="<%= item.id %>"></div>
								  <div class="item-course-id" icd="<%= item.course_id %>"></div>
							  	</div>
							<% end %>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-9 col-sm-6 simulator-fixed-calendar" dataPage="mobile" id="calendar-page">
			<div class="page-slider" style="padding-top: 24px;">
				<h4 class="simulator-title" style="display:none;"><%= current_user.name %>的課表</h4>
				<div class="garbage-can-field" id="garbage-can-delete">
					<button class="garbage-can-delete"></button>
				</div>
				<div class="import-to-mobile-field" style="float: right; margin-top: 5px;">
					<button id="import-to-mobile" class="import-to-mobile">匯入手機GOGO<i class="mdi-content-send right"></i></button>
				</div>
				<div style="clear: both;"></div>
				<div class="simulator-table-field" style="padding-top: 0 !important;">
					<table class="simulator-table">
						<thead>
							<tr>
								<th></th>
								<th>一</th>
								<th>二</th>
								<th>三</th>
								<th>四</th>
								<th>五</th>
								<th>六</th>
								<th>日</th>
							</tr>
						</thead>
						<tbody>
							<tr class="class1">
								<td>1</td>
								<td class="M1"></td>
								<td class="T1"></td>
								<td class="W1"></td>
								<td class="R1"></td>
								<td class="F1"></td>
								<td class="S1"></td>
								<td class="Sun1"></td>
							</tr>
							<tr class="class2">
								<td>2</td>
								<td class="M2"></td>
								<td class="T2"></td>
								<td class="W2"></td>
								<td class="R2"></td>
								<td class="F2"></td>
								<td class="S2"></td>
								<td class="Sun2"></td>
							</tr>
							<tr class="class3">
								<td>3</td>
								<td class="M3"></td>
								<td class="T3"></td>
								<td class="W3"></td>
								<td class="R3"></td>
								<td class="F3"></td>
								<td class="S3"></td>
								<td class="Sun3"></td>
							</tr>
							<tr class="class4">
								<td>4</td>
								<td class="M4"></td>
								<td class="T4"></td>
								<td class="W4"></td>
								<td class="R4"></td>
								<td class="F4"></td>
								<td class="S4"></td>
								<td class="Sun4"></td>
							</tr>
							<tr class="class5">
								<td>5</td>
								<td class="M5"></td>
								<td class="T5"></td>
								<td class="W5"></td>
								<td class="R5"></td>
								<td class="F5"></td>
								<td class="S5"></td>
								<td class="Sun5"></td>
							</tr>
							<tr class="class6">
								<td>6</td>
								<td class="M6"></td>
								<td class="T6"></td>
								<td class="W6"></td>
								<td class="R6"></td>
								<td class="F6"></td>
								<td class="S6"></td>
								<td class="Sun6"></td>
							</tr>
							<tr class="class7">
								<td>7</td>
								<td class="M7"></td>
								<td class="T7"></td>
								<td class="W7"></td>
								<td class="R7"></td>
								<td class="F7"></td>
								<td class="S7"></td>
								<td class="Sun7"></td>
							</tr>
							<tr class="class8">
								<td>8</td>
								<td class="M8"></td>
								<td class="T8"></td>
								<td class="W8"></td>
								<td class="R8"></td>
								<td class="F8"></td>
								<td class="S8"></td>
								<td class="Sun8"></td>
							</tr>
							<tr class="class9">
								<td>9</td>
								<td class="M9"></td>
								<td class="T9"></td>
								<td class="W9"></td>
								<td class="R9"></td>
								<td class="F9"></td>
								<td class="S9"></td>
								<td class="Sun9"></td>
							</tr>
							<tr class="class10">
								<td>10</td>
								<td class="M10"></td>
								<td class="T10"></td>
								<td class="W10"></td>
								<td class="R10"></td>
								<td class="F10"></td>
								<td class="S10"></td>
								<td class="Sun10"></td>
							</tr>
							<tr class="classA">
								<td>A</td>
								<td class="MA"></td>
								<td class="TA"></td>
								<td class="WA"></td>
								<td class="RA"></td>
								<td class="FA"></td>
								<td class="SA"></td>
								<td class="SunA"></td>
							</tr>
							<tr class="classB">
								<td>B</td>
								<td class="MB"></td>
								<td class="TB"></td>
								<td class="WB"></td>
								<td class="RB"></td>
								<td class="FB"></td>
								<td class="SB"></td>
								<td class="SunB"></td>
							</tr>
							<tr class="classC">
								<td>C</td>
								<td class="MC"></td>
								<td class="TC"></td>
								<td class="WC"></td>
								<td class="RC"></td>
								<td class="FC"></td>
								<td class="SC"></td>
								<td class="SunC"></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
// Mobile Mode Nav Control
// 手機模式下方的選單，點擊一個btn之後可以讓其他btn失效，達成tabs的效果。
	$(window).load(function(){
		$('#calendar-page').addClass('active');
		$('#calendar-trigger').click(function(){
			$('div[dataPage = "mobile"]').removeClass('active');
			$('#calendar-page').addClass('active');
		})
		$('#select-trigger').click(function(){
			$('div[dataPage = "mobile"]').removeClass('active');
			$('#select-page').addClass('active');
		})
	})

//

$('#course-hasselect-field-trigger').click(function(){
	$('#course-hasselect-field').toggleClass('active');
})

//
// 製作當滑鼠移到 td 上方時，底下被選的課程會從原本被堆疊的狀態展開。
// 反之，當滑鼠移開時，課程會收起來。
//
$(document).on('mouseover' ,'.simulator-table td', function(e){
	var coursecount = $(this).children('.simulator-table-course').length;
	var tdHeight = (coursecount * 35) + 30 + (coursecount - 1);
	var course_position = 0;
	var first_course_position = (coursecount / 2 - 0.5 ) * 35 * -1;
	if(coursecount >= 2){
		$(this).css({
			'height' : tdHeight + 'px'
		})
		$(this).children('.simulator-table-course:nth-child(1)').css({
			'top' : first_course_position + 'px'
		});
		for(i = 2; i <= coursecount ; i++ ){
			course_position = 15 + ((i - 1)*35) + (i - 1);
			$(this).children('.simulator-table-course:nth-child(' + i + ')').css({
				'transform' : '',
				'-moz-transform' : '',
				'-o-transform' : '',
				'-ms-transform' : '',
				'-webkit-transform' : '',
				'top' : course_position + 'px'
			});
		}
	}
})
$(document).on('mouseout' ,'.simulator-table td',function(e){
	var coursecount = $(this).children('.simulator-table-course').length;
	if(coursecount >= 2){
		$(this).css({
			'height' : ''
		})
		$(this).children('.simulator-table-course:nth-child(1)').css({
			'top' : ''
		});
		var degreebase = 7.5;
		var degree = 0;
		for(i = 2; i <= coursecount ; i++ ){
			degree = degreebase * (i - 1);
			$(this).children('.simulator-table-course:nth-child(' + i + ')').css({
				'transform' : 'rotate(' + degree + 'deg)',
				'-moz-transform' : 'rotate(' + degree + 'deg)',
				'-o-transform' : 'rotate(' + degree + 'deg)',
				'-ms-transform' : 'rotate(' + degree + 'deg)',
				'-webkit-transform' : 'rotate(' + degree + 'deg)',
				'top' : '15px'
			});
		}
	}
})

//
// 函式： 計算所有已選課程的學分數，並且 append 到統計裡面。
//
function CourseCreditsCounter(){
	var creditsTotal = 0;

	$('.credits').each(function(){
		var number = parseInt($(this).text());
		//numbers.push(number);
		creditsTotal = creditsTotal + number;
	})
	$('#credits-total').html('');
	$('#credits-total').append(creditsTotal);
}

//
// 函式： 選擇課程之後會把已經課程在 選擇界面中 disable 掉。
//
function courseSelectItemDisabledTest(){
	$('.course-select-item').removeClass('disabled');
	$('.item-course-id').each(function(){
		var icd = $(this).attr('icd');
		$('.course-id[cid="' + icd + '"]').parent('.course-select-item').addClass('disabled');
	})
}
//
// 當一個 td 底下有超過一個課程之後，加入衝堂的css狀態，並且加上堆疊效果。
//
function CourseConflictTest(){
	$('.simulator-table td').each(function(){
		var coursecount = $(this).children('.simulator-table-course').length;
		$(this).children('.simulator-table-course:nth-child(1)').removeClass('course-conflict-pack').css({
				'transform' : '',
				'-moz-transform' : '',
				'-o-transform' : '',
				'-ms-transform' : '',
				'-webkit-transform' : '',
				'top' : '0'
			});
		if (coursecount >= 2) {
			$(this).children('.simulator-table-course').addClass('course-conflict');
			var degreebase = 7.5;
			var degree = 0;
			for( i = 2; i <= coursecount ; i ++){
				degree = degreebase * (i - 1);
				$(this).children('.simulator-table-course:nth-child(' + i +')').addClass('course-conflict-pack').css({
					'transform' : 'rotate(' + degree + 'deg)',
					'-moz-transform' : 'rotate(' + degree + 'deg)',
					'-o-transform' : 'rotate(' + degree + 'deg)',
					'-ms-transform' : 'rotate(' + degree + 'deg)',
					'-webkit-transform' : 'rotate(' + degree + 'deg)'
				});
			};
		}else{
			$(this).children('.simulator-table-course:nth-child(1)').removeClass('course-conflict').css({
				'transform' : '',
				'-moz-transform' : '',
				'-o-transform' : '',
				'-ms-transform' : '',
				'-webkit-transform' : ''
			});
		}
	});
}

//
//
//
function splitACourse() {
	var courseItem = $('.course-hasselect-item');
	courseItem.each(function(){
		var course_name = $(this).children(".name").text();
		var item_id = $(this).children(".item-id").attr('iid');
		var course_times = $(this).children(".time").text().split(" ");
		var counter = course_times.length;
		console.log(counter);

		for (var i = 0; i < counter; i++) {
			var thisCourse = course_times[i]
			console.log(thisCourse);
			console.log(course_name);
			$('<div class="simulator-table-course active" iid="' + item_id + '">' + course_name + '</div>').appendTo('.'+ thisCourse ).draggable({
				revert: true,
				start: function() {
					$(this).removeClass('active');
					$('.garbage-can-field').addClass('active');
					$('.mobile-bottom-nav').addClass('hide');
				},
				drag: function() {
				},
				stop: function() {
					$(this).addClass('active');
					$('.garbage-can-field').removeClass('active');
					$('.mobile-bottom-nav').removeClass('hide');
				}

			});

		};
		$(".garbage-can-field").droppable({
	        activeClass: "",
	        hoverClass: "hover",
	        accept: ".simulator-table-course",
	        drop: function(event, ui) {
			 	item_id = $(ui.draggable).attr('iid');
				$.ajax({
					url:'/courses_simulator/' + item_id,
					type: 'DELETE',
					success: function(response) {
						var item = response["item"];
						var course = response["course"];
						var course_name = course.course_name;

						$('.course-id[cid="' + item.course_id + '"]').parent('.course-select-item').removeClass('disabled');
						console.log(item);
						$('.item-id[iid=' + item["id"] +']').parent('.course-hasselect-item').remove();
						$('.simulator-table-course[iid="' + item["id"] + '"]').remove();
						Materialize.toast('"' + course_name + '" 已經移出課表！', 100000);
						CourseConflictTest();
						CourseCreditsCounter();
					}
				})
	        }
	    })
	})
	CourseConflictTest();
}

splitACourse();
CourseCreditsCounter();
courseSelectItemDisabledTest()

$(document).ready(function() {
	$('ul.tabs').tabs();
	$('.add-to-simulator').click(function() {
		course_id = $(this).siblings('.course-id').attr('cid');

		$.post('/courses_simulator', {"courses_simulator[course_id]": course_id}, function(response) {
			    var course = response["course"]
				var course_name = course["course_name"];
				var course_time = course["course_time"];
				var course_lecturer = course["lecturer_name"];
				var course_code = course["course_code"]
				var credits = course["credits"];
				var location = course["location"]
				var course_times = course["course_time"].split(" ");
				var counter = course_times.length;
				var item = response["item"]
				var item_id = item["id"]

				$('.course-id[cid="' + course_id + '"]').parent('.course-select-item').addClass('disabled');
				for (var i = 0; i < counter; i++) {
					var thisCourse = course_times[i];
					$('<div class="simulator-table-course active" iid="' + item_id + '">' + course_name + '</div>').appendTo('.'+ thisCourse ).draggable({
							revert: true,
							start: function() {
								$(this).removeClass('active');
								$('.garbage-can-field').addClass('active');
								$('.mobile-bottom-nav').addClass('hide');
							},
							drag: function() {
							},
							stop: function() {
								$(this).addClass('active');
								$('.garbage-can-field').removeClass('active');
								$('.mobile-bottom-nav').removeClass('hide');
							}

						});

				};
				$(".garbage-can-field").droppable({
			        activeClass: "",
			        hoverClass: "hover",
			        accept: ".simulator-table-course",
			        drop: function(event, ui) {
					 	item_id = $(ui.draggable).attr('iid');
						$.ajax({
							url:'/courses_simulator/' + item_id,
							type: 'DELETE',
							success: function(response) {
								var item = response["item"];
								var course = response["course"];
								var course_name = course.course_name;
								$('.course-id[cid="' + item.course_id + '"]').parent('.course-select-item').removeClass('disabled');
								console.log(item);
								$('.item-id[iid=' + item["id"] +']').parent('.course-hasselect-item').remove();
								$('.simulator-table-course[iid="' + item["id"] + '"]').remove();
								Materialize.toast('"' + course_name + '" 已經移出課表！', 2000);
								CourseConflictTest();
								CourseCreditsCounter();
							}
						})
			        }
			    })
				$('.course-hasselect-field-inner').append(
					'<div class="course-hasselect-item">' +
					  '<div class="name"><a href="http://table.colorgy.dev/courses/'+
					  course_id + '">' +
					   course_name + '</a></div>' +
					  '<div class="lecturer">'+ course_lecturer + '</div>' +
					  '<div class="code">'+ course_code + '</div>' +
					  '<br>' +
					  '<div class="time">'+ course_time + '</div>' +
					  '<div class="location">' + location + '</div>' +
					  '<div class="credits">' + credits + '</div>' +
					  '<button class="remove-hasselect-course"><i class="mdi-content-clear"></i></button>' +
					  '<div class="item-id" iid="' + item_id + '"></div>' +
				  	'</div>');

				Materialize.toast('"' + course_name + '" 已經加入課表！', 2000000);

				CourseConflictTest();
				CourseCreditsCounter();
		})
	}).bind(this);


});
$(document).on('click','.remove-hasselect-course' , function() {
     //code here ....
 	item_id = $(this).siblings('.item-id').attr('iid');
	$.ajax({
		url:'/courses_simulator/' + item_id,
		type: 'DELETE',
		success: function(response) {
			var item = response["item"];
			var course = response["course"];
			var course_name = course.course_name;

			$('.course-id[cid="' + item.course_id + '"]').parent('.course-select-item').removeClass('disabled');
			console.log(item);
			$('.item-id[iid=' + item["id"] +']').parent('.course-hasselect-item').remove();
			$('.simulator-table-course[iid="' + item["id"] + '"]').remove();
			Materialize.toast('"' + course_name + '" 已經移出課表！', 2000);
			CourseConflictTest();
			CourseCreditsCounter();
		}
	})
});
</script>

